<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title><?= htmlspecialchars($store->nickname) ?> 統計數據</title>
    <?php include(VIEWS_DIR . "/include/static_common.html"); ?>
    <script type="text/javascript" src="static/highcharts.src.js"></script>
</head>

<body>
<?php include(VIEWS_DIR . "/include/manage_nav.html"); ?>

<div class="container">
    <div>
        <h1><?= htmlspecialchars($store->nickname) ?> 統計數據</h1>
    </div>
    <ul class="nav nav-pills">
        <li role="presentation" <?php if ('overview' == $topic) { ?>class="active"<?php } ?>><a href="/statistics.php">總覽</a></li>
        <li role="presentation" <?php if ('customers' == $topic) { ?>class="active"<?php } ?>><a href="/statistics.php?topic=customers">來客</a></li>
        <li role="presentation" <?php if ('product' == $topic) { ?>class="active"<?php } ?>><a href="/statistics.php?topic=product">商品</a></li>
        <li role="presentation" <?php if ('category' == $topic) { ?>class="active"<?php } ?>><a href="/statistics.php?topic=category">分類</a></li>
        <li role="presentation" <?php if ('event' == $topic) { ?>class="active"<?php } ?>><a href="/statistics.php?topic=event">折扣活動</a></li>
    </ul>
    <div class="bordered-block">
        <h2>按月統計</h2>
        <div id="month_chart"></div>
    </div>
    <div class="bordered-block">
        <h2>按日統計</h2>
        <div id="date_chart"></div>
    </div>
</div>

<script>
var chart;
var highchart = function(title, renderTo, categories, count_datasets, avg_datasets) {
    var series = [];
    series.push({
        type: 'column',
        name: '總來客數',
        data: count_datasets['總來客數']
    }, {
        type: 'line',
        name: '平均客單價',
        yAxis: 1,
        data: avg_datasets['平均客單價'],
        tooltip: {
            valuePrefix: '$'
        }
    });
    var char_options = {
        chart: {
            renderTo: renderTo
        },
        title: {
            text: title,
            x: -20 //center
        },
        subtitle: {
            text: '',
            x: -20
        },
        xAxis: {
            categories: categories
        },
        yAxis: [{
            title: {
                text: '人次'
            },
            labels: {
                style: {
                    color: Highcharts.getOptions().colors[0]
                }
            }
        }, {
            title: {
                text: '金額'
            },
            labels: {
                style: {
                    color: Highcharts.getOptions().colors[1]
                }
            },
            opposite: true
        }],
        plotOptions: {
            series: {
                dataLabels: {
                    enabled: true,
                    formatter: function() {
                        if ('平均客單價' === this.series.name) {
                            return '$' + this.y;
                        } else {
                            return this.y;
                        }
                    }
                }
            }
        },
        tooltip: {
            pointFormat: '{series.name}: <b>{point.y}</b><br/>',
            shared: true
        },
        legend: {
            layout: 'vertical',
            align: 'right',
            verticalAlign: 'middle'
        },
        series: series
    };

    chart = new Highcharts.Chart(char_options);
};

highchart(
    '總來客數與平均客單價',
    'month_chart',
    <?= json_encode($month_stat_result->getChart('來客數統計')->getXAxisCategories()) ?>,
    <?= json_encode($month_stat_result->getChart('來客數統計')->getDataSets()) ?>,
    <?= json_encode($month_stat_result->getChart('平均客單價')->getDataSets()) ?>
);

highchart(
    '總來客數與平均客單價',
    'date_chart',
    <?= json_encode($date_stat_result->getChart('來客數統計')->getXAxisCategories()) ?>,
    <?= json_encode($date_stat_result->getChart('來客數統計')->getDataSets()) ?>,
    <?= json_encode($date_stat_result->getChart('平均客單價')->getDataSets()) ?>
);
</script>
</body>
</html>
